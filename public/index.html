<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Control</title>
  <style>
    :root{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --panel2:#f2f6ff;
      --text:#0b1220;
      --muted:#516074;
      --line:#e2e8f0;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --accent:#2563eb;
      --accent2:#7c3aed;
      --pink:#ec4899;
      --chip:#eef2ff;
      --radius:18px;
      --gap:12px;
      --pad:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(37,99,235,0.14), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(124,58,237,0.12), transparent 55%),
        radial-gradient(800px 520px at 50% 100%, rgba(236,72,153,0.10), transparent 60%),
        var(--bg);
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{
      position:sticky; top:0; z-index:8;
      background:rgba(246,248,255,0.85); backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:14px 14px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(124,58,237,1), rgba(236,72,153,1));
      box-shadow: 0 18px 35px rgba(37,99,235,0.22);
    }
    h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .row{ display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      border:1px solid var(--line); background:var(--panel);
      padding:8px 10px; border-radius:999px; font-size:13px; color:var(--muted);
      cursor:pointer; user-select:none;
      box-shadow: 0 10px 18px rgba(2,6,23,0.05);
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(37,99,235,0.35);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.12) inset, 0 10px 18px rgba(2,6,23,0.05);
    }
    .btn{
      border:1px solid var(--line); background:var(--panel); color:var(--text);
      padding:9px 11px; border-radius:14px; cursor:pointer; font-size:13px;
      box-shadow: 0 14px 26px rgba(2,6,23,0.07);
      transition: transform .06s ease;
    }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn:hover{ border-color:rgba(37,99,235,0.30); }
    .btn.primary{
      border:1px solid rgba(37,99,235,0.22);
      background: linear-gradient(135deg, rgba(37,99,235,0.12), rgba(124,58,237,0.10), rgba(236,72,153,0.08));
    }
    .btn.good{ border-color:rgba(22,163,74,0.35); }
    .btn.bad{ border-color:rgba(220,38,38,0.35); }

    main{ padding:14px 0 40px; }
    .grid{ display:grid; gap:var(--gap); }
    @media (min-width: 1020px){
      .grid.cols2{ grid-template-columns: 1.15fr 0.85fr; }
      .grid.cols3{ grid-template-columns: 0.9fr 1.1fr 1fr; }
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:var(--pad);
      box-shadow: 0 18px 34px rgba(2,6,23,0.08);
    }
    .card h2{ font-size:14px; margin:0 0 10px; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--chip); border:1px solid rgba(37,99,235,0.16);
      padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted);
    }
    .pill strong{ color:var(--text); font-weight:800; }
    .spark{
      display:inline-flex; width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(124,58,237,1), rgba(236,72,153,1));
      box-shadow: 0 8px 18px rgba(124,58,237,0.25);
    }
    .split{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .field{ display:grid; gap:6px; margin-top:10px; }
    label{ font-size:12px; color:var(--muted); }
    input, select, textarea{
      width:100%; border:1px solid var(--line); background:var(--panel2);
      color:var(--text); border-radius:14px; padding:10px 10px; outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }
    input:focus, textarea:focus, select:focus{
      border-color:rgba(37,99,235,0.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.12);
    }
    .hr{ height:1px; background:var(--line); margin:12px 0; }

    .callout{
      border:1px solid rgba(37,99,235,0.22);
      background: linear-gradient(135deg, rgba(37,99,235,0.08), rgba(124,58,237,0.06), rgba(236,72,153,0.05));
      padding:10px; border-radius:14px;
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.45; }

    /* Gamification */
    .xpbar{
      width:100%; height:10px; border-radius:999px;
      background: rgba(2,6,23,0.06);
      overflow:hidden;
      border:1px solid rgba(2,6,23,0.06);
    }
    .xpfill{
      height:100%;
      background: linear-gradient(90deg, rgba(37,99,235,1), rgba(124,58,237,1), rgba(236,72,153,1));
      width:0%;
      border-radius:999px;
      transition: width .3s ease;
    }

    .kpi{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; }
    .kpi .box{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(241,245,255,0.75), rgba(255,255,255,1));
      border-radius:16px; padding:10px;
    }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .n{ font-size:18px; font-weight:900; margin-top:2px; }

    .list{ display:grid; gap:10px; }
    .item{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(241,245,255,0.75), rgba(255,255,255,1));
      border-radius:16px; padding:10px;
    }
    .item .top{ display:flex; gap:10px; justify-content:space-between; align-items:flex-start; }
    .item .title{ font-weight:900; }
    .tag{
      background:var(--chip); border:1px solid rgba(2,6,23,0.08);
      padding:4px 8px; border-radius:999px; font-size:12px; color:var(--muted);
      display:inline-flex; gap:6px; align-items:center;
    }
    .tag.good{ border-color:rgba(22,163,74,0.22); }
    .tag.warn{ border-color:rgba(245,158,11,0.25); }
    .tag.bad{ border-color:rgba(220,38,38,0.22); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .checkrow{ display:flex; gap:10px; align-items:flex-start; }
    .checkrow input[type="checkbox"]{ width:18px; height:18px; margin-top:2px; }

    /* Weekly planner */
    .planner{
      display:grid;
      grid-template-columns: 80px repeat(7, minmax(110px,1fr));
      gap:8px;
      overflow:auto;
      padding-bottom:8px;
    }
    .pl-h{
      font-size:11px; color:var(--muted); font-weight:800;
      padding:8px; border-radius:12px;
      background: rgba(2,6,23,0.04);
      border:1px solid rgba(2,6,23,0.05);
      text-align:center;
      white-space:nowrap;
    }
    .pl-slot{
      background: rgba(241,245,255,0.75);
      border:1px dashed rgba(2,6,23,0.12);
      border-radius:14px;
      padding:8px;
      min-height:56px;
      cursor:pointer;
    }
    .pl-slot:hover{ border-color: rgba(37,99,235,0.30); }
    .pl-time{
      font-size:11px; color:var(--muted); font-weight:900;
      padding:8px; border-radius:12px;
      background: rgba(2,6,23,0.04);
      border:1px solid rgba(2,6,23,0.05);
      text-align:center;
      white-space:nowrap;
    }
    .block{
      border:1px solid rgba(2,6,23,0.08);
      background: linear-gradient(135deg, rgba(37,99,235,0.10), rgba(124,58,237,0.08), rgba(236,72,153,0.06));
      border-radius:12px;
      padding:6px 8px;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      margin-top:6px;
    }
    .block small{ color:var(--muted); font-weight:700; }
    .x{
      border:none; background:transparent; cursor:pointer; color:rgba(220,38,38,0.9);
      font-weight:900;
    }

    table{ width:100%; border-collapse:collapse; }
    th, td{
      border-bottom:1px solid var(--line);
      padding:8px; text-align:left; font-size:12px; vertical-align:top;
    }
    th{ color:var(--muted); font-weight:900; }
    .nowrap{ white-space:nowrap; }
    .right{ text-align:right; }

    .toast{
      position:fixed; right:14px; bottom:14px; background:var(--panel);
      border:1px solid var(--line); padding:10px 12px; border-radius:14px;
      font-size:12px; color:var(--text);
      box-shadow: 0 22px 38px rgba(2,6,23,0.16);
      display:none;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Mission Control</h1>
          <div class="sub" id="todayLine"></div>
        </div>
      </div>
      <div class="row">
        <div class="tabs" id="tabs"></div>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
        <button class="btn bad" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- DASH -->
  <section id="viewDash" class="view">
    <div class="grid cols3">
      <div class="card">
        <div class="split">
          <h2><span class="spark"></span> Today‚Äôs Status</h2>
          <button class="btn primary" id="whatNextBtn">What next?</button>
          <button class="btn primary" id="checkJobsBtn">Check live roles</button>
          <button class="btn" id="genCvBtn">Generate CV</button>
        </div>
        <div class="hr"></div>

        <div class="kpi">
          <div class="box">
            <div class="t">Level</div>
            <div class="n" id="lvl">1</div>
          </div>
          <div class="box">
            <div class="t">Streak</div>
            <div class="n" id="streak">0</div>
          </div>
          <div class="box">
            <div class="t">Today XP</div>
            <div class="n" id="xpToday">0</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="muted" style="font-weight:900; margin-bottom:6px">XP to next level</div>
        <div class="xpbar"><div class="xpfill" id="xpFill"></div></div>
        <div class="hint" id="xpHint" style="margin-top:8px"></div>

        <div class="hr"></div>

        <div class="callout">
          <div class="hint">
            <strong>ADHD rules that win:</strong><br>
            1) <strong>Start ugly</strong> (momentum beats perfection)<br>
            2) <strong>Time-box</strong> (25‚Äì60 mins) <br>
            3) <strong>Cash + options first</strong>, then building
          </div>
        </div>

        <div class="hr"></div>

        <h2>Focus Timer</h2>
        <div class="row">
          <select id="timerPreset" style="width:160px">
            <option value="25">25 min</option>
            <option value="45">45 min</option>
            <option value="60" selected>60 min</option>
            <option value="90">90 min</option>
          </select>
          <button class="btn good" id="timerStart">Start</button>
          <button class="btn" id="timerPause">Pause</button>
          <button class="btn" id="timerReset">Reset</button>
        </div>
        <div class="hr"></div>
        <div class="pill"><strong id="timerLeft">60:00</strong> <span class="muted">remaining</span></div>
      </div>

      <div class="card">
        <div class="split">
          <h2>Today‚Äôs Missions</h2>
          <div class="row">
            <button class="btn good" id="addMissionBtn">+ Add</button>
            <button class="btn primary" id="startNextBtn">Start next</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="list" id="missionList"></div>
      </div>

      <div class="card">
        <h2>Your Compass</h2>
        <div class="hint" id="identitySticker"></div>
        <div class="hr"></div>

        <h2>Builder‚Äôs Licence (30 sec)</h2>
        <div class="field">
          <label>What outcome does this help?</label>
          <input id="licenceRole" placeholder="Role / money / case study" />
        </div>
        <div class="field">
          <label>One sentence for an interview</label>
          <input id="licenceSentence" placeholder="I built X to improve Y by Z." />
        </div>
        <div class="field">
          <label>Did you do 1 career action today?</label>
          <select id="licenceCareerDone">
            <option value="no">No ‚Üí do it first</option>
            <option value="yes">Yes ‚Üí build allowed (time-boxed)</option>
          </select>
        </div>

        <div class="hr"></div>
        <h2>Weekly targets (hours)</h2>
        <div class="hint">Set once. The dashboard shows if you‚Äôre on track.</div>

        <div class="field"><label>Work (cash)</label><input id="tWork" type="number" min="0" step="0.5"></div>
        <div class="field"><label>Career (options)</label><input id="tCareer" type="number" min="0" step="0.5"></div>
        <div class="field"><label>Build (compounding)</label><input id="tBuild" type="number" min="0" step="0.5"></div>
        <div class="field"><label>Gym</label><input id="tGym" type="number" min="0" step="0.5"></div>
        <div class="field"><label>Walk (solo)</label><input id="tWalk" type="number" min="0" step="0.5"></div>
        <div class="field"><label>Dog walks</label><input id="tDog" type="number" min="0" step="0.5"></div>
        <div class="field"><label>Family time</label><input id="tFamily" type="number" min="0" step="0.5"></div>

        <div class="hr"></div>
        <h2>This week: hours logged</h2>
        <div class="kpi">
          <div class="box"><div class="t">Cash (Work)</div><div class="n" id="hWork">0</div></div>
          <div class="box"><div class="t">Options (Career)</div><div class="n" id="hCareer">0</div></div>
          <div class="box"><div class="t">Build</div><div class="n" id="hBuild">0</div></div>
        </div>
        <div class="kpi" style="margin-top:10px">
          <div class="box"><div class="t">Gym</div><div class="n" id="hGym">0</div></div>
          <div class="box"><div class="t">Dog</div><div class="n" id="hDog">0</div></div>
          <div class="box"><div class="t">Family</div><div class="n" id="hFamily">0</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PLANNER -->
  <section id="viewPlan" class="view" style="display:none">
    <div class="grid cols2">
      <div class="card">
        <div class="split">
          <h2>Weekly Planner</h2>
          <div class="row">
            <button class="btn primary" id="autoPlanBtn">Auto-plan week</button>
            <button class="btn" id="clearPlanBtn">Clear</button>
          </div>
        </div>
        <div class="hr"></div>

        <div class="callout">
          <div class="hint">
            Click any slot ‚Üí pick a block type (Work/Career/Build/Gym/Walk/Dog/Family).<br>
            Auto-plan creates a sensible default based on your weekly target hours.
          </div>
        </div>

        <div class="hr"></div>

        <div class="planner" id="planner"></div>
      </div>

      <div class="card">
        <h2>Quick add blocks</h2>
        <div class="hint">Good defaults: dog walk daily, gym 3x/week, family anchor blocks.</div>
        <div class="hr"></div>

        <div class="field">
          <label>Block label</label>
          <input id="blkLabel" placeholder="e.g. Career: apply + message" />
        </div>
        <div class="field">
          <label>Type</label>
          <select id="blkType">
            <option value="work">Work</option>
            <option value="career">Career</option>
            <option value="build">Build</option>
            <option value="gym">Gym</option>
            <option value="walk">Walk</option>
            <option value="dog">Dog</option>
            <option value="family">Family</option>
          </select>
        </div>
        <div class="field">
          <label>Duration (hours)</label>
          <select id="blkDur">
            <option value="0.5">0.5</option>
            <option value="1" selected>1</option>
            <option value="1.5">1.5</option>
            <option value="2">2</option>
          </select>
        </div>
        <button class="btn good" id="addQuickBlockBtn">Add to next empty slot</button>

        <div class="hr"></div>
        <h2>Log time (for weekly hours)</h2>
        <div class="hint">Log what you actually did. That‚Äôs the scoreboard.</div>

        <div class="field">
          <label>Type</label>
          <select id="logType">
            <option value="work">Work</option>
            <option value="career">Career</option>
            <option value="build">Build</option>
            <option value="gym">Gym</option>
            <option value="walk">Walk</option>
            <option value="dog">Dog</option>
            <option value="family">Family</option>
          </select>
        </div>
        <div class="field">
          <label>Hours</label>
          <select id="logHours">
            <option value="0.25">0.25</option>
            <option value="0.5">0.5</option>
            <option value="0.75">0.75</option>
            <option value="1" selected>1</option>
            <option value="1.5">1.5</option>
            <option value="2">2</option>
          </select>
        </div>
        <div class="field">
          <label>Note</label>
          <input id="logNote" placeholder="Optional" />
        </div>
        <button class="btn primary" id="addLogBtn">Log</button>

        <div class="hr"></div>
        <h2>Badges</h2>
        <div class="hint" id="badges"></div>
      </div>
    </div>
  </section>

  <!-- JOBS -->
  <section id="viewJobs" class="view" style="display:none">
    <div class="grid cols2">
      <div class="card">
        <div class="split">
          <h2>Jobs / Companies</h2>
          <div class="row">
            <button class="btn good" id="addJobBtn">+ Add row</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Filter</label>
          <input id="jobFilter" placeholder="Company, status, rank‚Ä¶" />
        </div>

        <div style="overflow:auto; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th class="nowrap">Rank</th>
                <th class="nowrap">Days</th>
                <th>Company</th>
                <th>Careers link</th>
                <th>Status</th>
                <th>Job link</th>
                <th class="nowrap">Date applied</th>
                <th>Impact</th>
                <th>Action on me</th>
                <th class="nowrap right">Actions</th>
              </tr>
            </thead>
            <tbody id="jobsTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Paste from Sheets</h2>
        <div class="hint">Paste your tabbed rows straight in. No prep.</div>

        <div class="field">
          <label>Paste block</label>
          <textarea id="jobsPaste" placeholder="Ranking\tDays in office\tCompany\tLink for website\tStatus\tLink for job\tDate applied\tImpact\tAction on me"></textarea>
        </div>

        <div class="row">
          <button class="btn good" id="parseJobsBtn">Parse & Add</button>
          <button class="btn" id="clearPasteBtn">Clear</button>
        </div>

        <div class="hr"></div>
        <h2>Quick KPIs</h2>
        <div class="row">
          <span class="pill"><span class="spark"></span> <strong id="kpiTop">0</strong> top-ranked</span>
          <span class="pill"><span class="spark"></span> <strong id="kpiActive">0</strong> active</span>
          <span class="pill"><span class="spark"></span> <strong id="kpiCold">0</strong> cold</span>
        </div>

        <div class="hr"></div>
        <div class="callout">
          <div class="hint">
            <strong>Monotony killer:</strong> keep a ‚Äúwatchlist‚Äù status and check it twice weekly, not daily.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS / VALUES -->
  <section id="viewValues" class="view" style="display:none">
    <div class="grid cols2">
      <div class="card">
        <h2>Values / identity (editable)</h2>
        <div class="field">
          <label>Headline</label>
          <input id="idHeadline" />
        </div>
        <div class="field">
          <label>Cornerstones</label>
          <textarea id="cornerstones"></textarea>
        </div>
        <div class="field">
          <label>Non-negotiables</label>
          <textarea id="nonnegotiables"></textarea>
        </div>
      </div>

      <div class="card">
        <h2>Chimp controls (editable)</h2>
        <div class="hint">Not a fight. A management plan.</div>
        <div class="field">
          <label>Triggers</label>
          <textarea id="chimpTriggers"></textarea>
        </div>
        <div class="field">
          <label>Fast soothing</label>
          <textarea id="chimpSoothing"></textarea>
        </div>
        <div class="field">
          <label>Computer rules (IF ‚Üí THEN)</label>
          <textarea id="computerRules"></textarea>
        </div>
      </div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
(function(){
  const KEY = "mission_control_v3";
  const $ = (id) => document.getElementById(id);
  const fmtDate = (d) => d.toISOString().slice(0,10);
  const today = new Date();
  const todayKey = fmtDate(today);

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=> t.style.display="none", 1400);
  }

  // ---- Seed jobs (subset of your list; you can paste full list in Jobs tab)
  const seedJobs = [
    ["1","1","Propellernet","https://www.propellernet.co.uk/careers/","No jobs","","","",""],
    ["1.1","2","Velocity Partners","https://velocitypartners.com/jobs/","No jobs","","","",""],
    ["1","1","Bind Media","https://www.bind.media/careers","No jobs","","","",""],
    ["1","1","KOTA","https://www.linkedin.com/company/kota-creative/jobs/","No jobs","","","",""],
    ["1","1","Equal Experts","https://www.equalexperts.com/current-opportunities/","No jobs","","","",""],
    ["1","1","Tide","https://job-boards.greenhouse.io/tide","No jobs","","","",""],
    ["2","3","Informa","https://careers.smartrecruiters.com/InformaGroupPlc/","","","","Looks like they could be 3 days a week",""],
    ["","", "Beazley","https://careers.beazley.com/jobs?tags1=United%20Kingdom&page=1&limit=25","No jobs","","","",""],
    ["1","1","Awin","https://group.awin.com/careers/","Not Applied","https://www.awin.com/gb/careers/vacancies/7586133003","","",""],
    ["1.1","2","RELX","https://relx.wd3.myworkdayjobs.com/relx?Country___Territory=29247e57dbaf46fb855b224e03170bc7","Not Applied","https://relx.wd3.myworkdayjobs.com/en-US/relx/job/Senior-Manager--Segment-Proposition_R103918-1","","",""],
    ["1","1","Atlassian","https://www.atlassian.com/company/careers/all-jobs?team=&location=United%20Kingdom&search=","Not Applied","https://www.atlassian.com/company/careers/details/23994","","",""],
    ["1","1","GitLab","https://about.gitlab.com/jobs/","No jobs","","","",""],
    ["1.1","2","HubSpot","https://www.hubspot.com/careers","No jobs","","","",""],
    ["1","1","GitHub","https://www.github.careers/careers-home/jobs?locations=,,United%20Kingdom&page=1","No jobs","","","",""],
    ["1","1","Canva","https://www.lifeatcanva.com/en/jobs/?search=&country=United+Kingdom&pagesize=20#results","No jobs","","","",""],
    ["1","1","Elastic","https://www.elastic.co/careers/","No jobs","","","",""],
    ["2","3","Wise","https://wise.jobs/jobs?options=343&page=1&size=48","No jobs","","","",""],
    ["1","1","Monzo","https://monzo.com/careers","","https://job-boards.greenhouse.io/monzo/jobs/7279084","","",""]
  ];

  const defaultState = {
    ui: { tab: "Dash" },
    values: {
      headline: "Steady operator. Builder with judgement. Action over outcome.",
      cornerstones: [
        "Cash + options first. Then build.",
        "Time-box everything. Momentum > perfection.",
        "Me-vs-me scoreboard. Comparisons are noise.",
        "Calm strength: steady partner + dad.",
        "Ship visible outcomes (not drafts)."
      ],
      nonnegotiables: [
        "No hiding in tinkering to avoid applying.",
        "No vague CV claims: outcomes/metrics only.",
        "No thrash: one main focus per day."
      ]
    },
    chimp: {
      triggers: ["Ambiguity", "Rejection / judgement", "Overtired + overstimulated", "Scrolling + novelty"],
      soothing: ["10 min walk", "Music + tidy 1 surface", "Cold water face", "Write 3 bullets: what matters today"],
      rules: ["IF I want to build, THEN I do 1 career action first."]
    },
    licence: { role:"", sentence:"", careerDone:"no" },
    game: {
      xpTotal: 0,
      streak: 0,
      lastCompleteDate: "",
      todayXp: 0
    },
    targets: { work: 28, career: 8, build: 6, gym: 3, walk: 3, dog: 6, family: 10 },
    days: {},
    jobs: [],
    logs: [], // {dateKey, type, hours, note}
    plan: {}  // {weekKey: {slotId: [blocks]}}
  };

  function weekKeyFor(d){
    // ISO-ish week key (YYYY-WW)
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
  }

  function deepMerge(target, src){
    for(const k in src){
      if(src[k] && typeof src[k] === "object" && !Array.isArray(src[k]) && target[k]){
        deepMerge(target[k], src[k]);
      }else{
        target[k] = src[k];
      }
    }
  }
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw){
        const s = structuredClone(defaultState);
        s.jobs = seedJobs.map(r => ({
          id: uid(),
          rank: r[0], daysOffice:r[1], company:r[2], careersLink:r[3],
          status:r[4], jobLink:r[5], dateApplied:r[6], impact:r[7], actionOnMe:r[8]
        }));
        return s;
      }
      const parsed = JSON.parse(raw);
      const s = structuredClone(defaultState);
      deepMerge(s, parsed);
      if(!Array.isArray(s.jobs) || s.jobs.length===0){
        s.jobs = seedJobs.map(r => ({
          id: uid(),
          rank: r[0], daysOffice:r[1], company:r[2], careersLink:r[3],
          status:r[4], jobLink:r[5], dateApplied:r[6], impact:r[7], actionOnMe:r[8]
        }));
      }
      return s;
    }catch{
      const s = structuredClone(defaultState);
      s.jobs = seedJobs.map(r => ({
        id: uid(),
        rank: r[0], daysOffice:r[1], company:r[2], careersLink:r[3],
        status:r[4], jobLink:r[5], dateApplied:r[6], impact:r[7], actionOnMe:r[8]
      }));
      return s;
    }
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  let state = load();

  // ---- Tabs
  const tabNames = ["Dash","Plan","Jobs","Values"];
  const tabMap = { Dash:"viewDash", Plan:"viewPlan", Jobs:"viewJobs", Values:"viewValues" };

  function renderTabs(){
    const el = $("tabs");
    el.innerHTML = "";
    tabNames.forEach(name=>{
      const b = document.createElement("div");
      b.className = "tab" + (state.ui.tab===name ? " active" : "");
      b.textContent = name;
      b.onclick = ()=>{ state.ui.tab=name; save(); render(); };
      el.appendChild(b);
    });
  }
  function showView(){
    tabNames.forEach(t=>{
      $(tabMap[t]).style.display = (state.ui.tab===t) ? "block" : "none";
    });
  }

  // ---- Header
  function renderHeader(){
    const day = today.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"short", day:"numeric" });
    $("todayLine").textContent = `${day} ‚Ä¢ Contract ends end of Aug ‚Ä¢ Cash + options first, then build`;
  }

  // ---- Identity
  function renderIdentity(){
    $("identitySticker").innerHTML = `
      <span class="pill"><span class="spark"></span><strong>${escapeHtml(state.values.headline)}</strong></span>
      <div class="hr"></div>
      <div class="hint"><strong>Cornerstones:</strong><br>‚Ä¢ ${state.values.cornerstones.map(escapeHtml).join("<br>‚Ä¢ ")}</div>
    `;
  }

  // ---- Missions
  function ensureDay(){
    if(!state.days[todayKey]) state.days[todayKey] = { missions: [] };
  }
  function addDefaultMissionsIfEmpty(){
    ensureDay();
    if(state.days[todayKey].missions.length) return;
    state.days[todayKey].missions = [
      {id:uid(), title:"Work: ship 1 visible outcome (cash)", type:"work", timebox:60, done:false},
      {id:uid(), title:"Career: 1 application OR 1 warm message (options)", type:"career", timebox:25, done:false},
      {id:uid(), title:"Dog: walk Penny", type:"dog", timebox:30, done:false},
      {id:uid(), title:"Build: 45 mins (only if career done)", type:"build", timebox:45, done:false},
      {id:uid(), title:"Family: 30 mins fully present", type:"family", timebox:30, done:false}
    ];
  }

  function typeMeta(type){
    const map = {
      work: {label:"WORK", cls:"warn", xp: 30},
      career:{label:"CAREER", cls:"good", xp: 35},
      build:{label:"BUILD", cls:"", xp: 20},
      gym:{label:"GYM", cls:"good", xp: 25},
      walk:{label:"WALK", cls:"", xp: 15},
      dog:{label:"DOG", cls:"", xp: 15},
      family:{label:"FAMILY", cls:"good", xp: 20}
    };
    return map[type] || {label:String(type||"").toUpperCase(), cls:"", xp: 10};
  }

  function renderMissions(){
    addDefaultMissionsIfEmpty();
    const list = $("missionList");
    const missions = state.days[todayKey].missions;

    list.innerHTML = "";
    missions.forEach(m=>{
      const meta = typeMeta(m.type);
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="top">
          <div style="flex:1">
            <div class="checkrow">
              <input type="checkbox" ${m.done?"checked":""} data-id="${m.id}" />
              <div style="flex:1">
                <div class="title">${escapeHtml(m.title)}</div>
                <div class="row" style="gap:8px; margin-top:6px">
                  <span class="tag ${meta.cls}"><span class="spark"></span>${meta.label}</span>
                  <span class="tag"><small>${m.timebox||0}m</small></span>
                  <span class="tag"><small>+${meta.xp} XP</small></span>
                </div>
              </div>
            </div>
          </div>
          <div class="actions">
            <button class="btn" data-play="${m.id}">Timer</button>
            <button class="btn" data-edit="${m.id}">Edit</button>
            <button class="btn bad" data-del="${m.id}">Del</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });

    list.querySelectorAll('input[type="checkbox"][data-id]').forEach(ch=>{
      ch.onchange = ()=>{
        const id = ch.dataset.id;
        const i = missions.findIndex(x=>x.id===id);
        if(i<0) return;

        missions[i].done = !missions[i].done;

        if(missions[i].done){
          awardForMission(missions[i]);
          // auto log hours (timebox minutes -> hours) for weekly tracking
          const hrs = Math.max(0.25, (Number(missions[i].timebox||30)/60));
          state.logs.push({ dateKey: todayKey, type: missions[i].type, hours: round2(hrs), note: missions[i].title });
        }else{
          // no XP removal (keeps it positive)
        }

        save();
        renderGame();
        renderWeeklyHours();
        renderBadges();
      };
    });

    list.querySelectorAll('button[data-edit]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.edit;
        const i = missions.findIndex(x=>x.id===id);
        if(i<0) return;
        const title = prompt("Mission title:", missions[i].title);
        if(title===null) return;
        const type = prompt("Type: work/career/build/gym/walk/dog/family", missions[i].type);
        if(type===null) return;
        const timebox = prompt("Timebox minutes (e.g. 25,45,60):", String(missions[i].timebox||60));
        if(timebox===null) return;
        missions[i].title = title.trim();
        missions[i].type = type.trim().toLowerCase();
        missions[i].timebox = Number(timebox)||60;
        save(); renderMissions();
      };
    });

    list.querySelectorAll('button[data-del]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.del;
        const i = missions.findIndex(x=>x.id===id);
        if(i>=0){ missions.splice(i,1); save(); renderMissions(); }
      };
    });

    list.querySelectorAll('button[data-play]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.play;
        const m = missions.find(x=>x.id===id);
        if(!m) return;
        $("timerPreset").value = String(m.timebox || 60);
        resetTimer();
        toast("Timer set from mission.");
      };
    });
  }

  $("addMissionBtn").onclick = ()=>{
    ensureDay();
    const title = prompt("Mission:", "Career: apply to 1 role");
    if(!title) return;
    const type = prompt("Type: work/career/build/gym/walk/dog/family", "career");
    if(!type) return;
    const mins = prompt("Timebox minutes:", "60");
    if(!mins) return;

    const t = type.trim().toLowerCase();
    if(t==="build" && state.licence.careerDone!=="yes"){
      toast("Build added ‚Äî but do 1 career action first.");
    }
    state.days[todayKey].missions.unshift({ id: uid(), title: title.trim(), type: t, timebox: Number(mins)||60, done:false });
    save(); renderMissions();
  };

  // ---- ‚ÄúWhat next?‚Äù and ‚ÄúStart next‚Äù
  $("whatNextBtn").onclick = ()=>{
  // ---- Live jobs (backend)
const PRIMARY = "https://mission-control-eight-blue.vercel.app";

$("checkJobsBtn").onclick = async () => {
  try {
    toast("Checking‚Ä¶");
    const r = await fetch(`${PRIMARY}/api/jobs`);
    const data = await r.json();
    alert(JSON.stringify(data, null, 2));
  } catch (e) {
    alert("Jobs check failed: " + (e.message || e));
  }
};

// ---- CV generator (backend)
$("genCvBtn").onclick = async () => {
  try {
    const roleTitle = prompt("Role title?", "Senior Manager / Head of Content");
    if (!roleTitle) return;

    const company = prompt("Company?", "Example Co");
    if (!company) return;

    const jobDescription = prompt("Paste job description (short ok):", "Paste here");
    if (!jobDescription) return;

    // Your profile source-of-truth (short for now; we‚Äôll expand later)
    const profile = `
12+ years digital marketing & growth. Senior roles at Meta, PlayStation, NatWest, King, Google.
Strengths: content + production leadership, cross-functional delivery, SEO/CRO, full-funnel strategy,
platform marketing, stakeholder management, measurable outcomes.
UK-based. Wants outcome ownership, judgment, execution in ambiguity.
Education: BA (Hons) Digital Media & Marketing, Oxford Brookes.
    `.trim();

    toast("Generating CV‚Ä¶");
    const r = await fetch(`${PRIMARY}/api/cv`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ roleTitle, company, jobDescription, profile })
    });

    const data = await r.json();
    if (!data.ok) throw new Error(data.error || "CV failed");

    // show in a new window for easy copy
    const w = window.open("", "_blank");
    w.document.write(`<pre style="white-space:pre-wrap;font:14px system-ui;padding:16px;">${escapeHtml(data.cv || "")}</pre>`);
    w.document.close();

    toast("CV ready.");
  } catch (e) {
    alert("CV failed: " + (e.message || e));
  }
};
    const m = pickNextMission();
    if(!m){ toast("No missions left. Add 1 small one."); return; }
    toast(`Next: ${m.title}`);
  };

  $("startNextBtn").onclick = ()=>{
    const m = pickNextMission();
    if(!m){ toast("No missions left."); return; }
    $("timerPreset").value = String(m.timebox || 60);
    resetTimer();
    startTimer();
    toast(`Started: ${m.title}`);
  };

  function pickNextMission(){
    ensureDay();
    const missions = state.days[todayKey].missions;
    const undone = missions.filter(x=>!x.done);

    if(!undone.length) return null;

    // ADHD-friendly priority logic:
    // 1) If no career action done, pick a career mission first
    // 2) If build appears but careerDone is "no", skip it
    // 3) Prefer short timeboxes for quick wins
    const careerDone = state.licence.careerDone === "yes";
    let candidates = undone.slice();

    if(!careerDone){
      const careerFirst = candidates.find(m=>m.type==="career");
      if(careerFirst) return careerFirst;
      candidates = candidates.filter(m=>m.type!=="build");
    }

    candidates.sort((a,b)=> (a.timebox||60) - (b.timebox||60));
    return candidates[0] || undone[0];
  }

  // ---- Builder‚Äôs licence
  function renderLicence(){
    $("licenceRole").value = state.licence.role || "";
    $("licenceSentence").value = state.licence.sentence || "";
    $("licenceCareerDone").value = state.licence.careerDone || "no";

    $("licenceRole").oninput = ()=>{ state.licence.role = $("licenceRole").value; save(); };
    $("licenceSentence").oninput = ()=>{ state.licence.sentence = $("licenceSentence").value; save(); };
    $("licenceCareerDone").onchange = ()=>{ state.licence.careerDone = $("licenceCareerDone").value; save(); };
  }

  // ---- Game system
  function levelFromXp(xp){
    // simple curve: 100 * lvl
    let lvl = 1;
    let need = 100;
    let remaining = xp;
    while(remaining >= need){
      remaining -= need;
      lvl++;
      need = 100 * lvl;
    }
    return {lvl, within: remaining, need};
  }

  function awardForMission(m){
    const meta = typeMeta(m.type);
    // Streak logic: streak = consecutive days with any completion
    const last = state.game.lastCompleteDate;
    if(last !== todayKey){
      // if yesterday, +1; else reset to 1
      const y = new Date(today); y.setDate(y.getDate()-1);
      const yKey = fmtDate(y);
      state.game.streak = (last === yKey) ? (state.game.streak + 1) : 1;
      state.game.lastCompleteDate = todayKey;
      state.game.todayXp = 0;
    }
    state.game.xpTotal += meta.xp;
    state.game.todayXp += meta.xp;

    // If career mission completed, mark careerDone yes automatically
    if(m.type === "career") state.licence.careerDone = "yes";
  }

  function renderGame(){
    // reset todayXp if new day and no completion yet
    if(state.game.lastCompleteDate !== todayKey){
      state.game.todayXp = 0;
    }
    const {lvl, within, need} = levelFromXp(state.game.xpTotal);
    $("lvl").textContent = String(lvl);
    $("streak").textContent = String(state.game.streak || 0);
    $("xpToday").textContent = String(state.game.todayXp || 0);
    const pct = Math.min(100, Math.round((within/need)*100));
    $("xpFill").style.width = pct + "%";
    $("xpHint").innerHTML = `<span class="pill"><strong>${pct}%</strong> to Level ${lvl+1}</span> <span class="muted">(${within}/${need} XP)</span>`;
  }

  function weekKeysLast7(){
    const keys = [];
    for(let i=0;i<7;i++){
      const d = new Date(today); d.setDate(d.getDate()-i);
      keys.push(fmtDate(d));
    }
    return keys;
  }

  function renderBadges(){
    const wk = weekKeyFor(today);
    const hours = sumWeekHours(wk);

    const badges = [];
    if((state.game.streak||0) >= 3) badges.push("üî• 3-day streak");
    if((state.game.streak||0) >= 7) badges.push("üèÜ 7-day streak");
    if(hours.career >= 3) badges.push("üéØ Career momentum");
    if(hours.work >= 10) badges.push("üíº Cash protected");
    if(hours.gym >= 2) badges.push("üèãÔ∏è Gym on track");
    if(hours.dog >= 3) badges.push("üê∂ Penny cared for");
    if(hours.family >= 4) badges.push("‚ù§Ô∏è Family anchor");

    $("badges").innerHTML = badges.length
      ? ("‚Ä¢ " + badges.join("<br>‚Ä¢ "))
      : "No badges yet this week. Start with one small win.";
  }

  // ---- Weekly hour targets + logs
  function round2(n){ return Math.round(n*100)/100; }

  function sumWeekHours(wkKey){
    const s = {work:0, career:0, build:0, gym:0, walk:0, dog:0, family:0};
    // Sum logs for dates in this week
    for(const l of state.logs){
      const d = new Date(l.dateKey + "T00:00:00");
      if(weekKeyFor(d) !== wkKey) continue;
      if(s[l.type] !== undefined) s[l.type] += Number(l.hours)||0;
    }
    for(const k in s) s[k] = round2(s[k]);
    return s;
  }

  function renderTargets(){
    $("tWork").value = state.targets.work;
    $("tCareer").value = state.targets.career;
    $("tBuild").value = state.targets.build;
    $("tGym").value = state.targets.gym;
    $("tWalk").value = state.targets.walk;
    $("tDog").value = state.targets.dog;
    $("tFamily").value = state.targets.family;

    const bind = (id, key)=>{
      $(id).oninput = ()=>{
        state.targets[key] = Number($(id).value)||0;
        save();
        renderWeeklyHours();
      };
    };
    bind("tWork","work"); bind("tCareer","career"); bind("tBuild","build");
    bind("tGym","gym"); bind("tWalk","walk"); bind("tDog","dog"); bind("tFamily","family");
  }

  function renderWeeklyHours(){
    const wk = weekKeyFor(today);
    const hours = sumWeekHours(wk);
    $("hWork").textContent = hours.work;
    $("hCareer").textContent = hours.career;
    $("hBuild").textContent = hours.build;
    $("hGym").textContent = hours.gym;
    $("hDog").textContent = hours.dog;
    $("hFamily").textContent = hours.family;
  }

  $("addLogBtn").onclick = ()=>{
    const type = $("logType").value;
    const hours = Number($("logHours").value)||0;
    const note = ($("logNote").value||"").trim();
    state.logs.push({ dateKey: todayKey, type, hours, note });
    $("logNote").value = "";
    save();
    renderWeeklyHours();
    renderBadges();
    toast("Logged.");
  };

  // ---- Weekly planner grid
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const slots = ["AM 1","AM 2","PM 1","PM 2","EVE"];
  function slotId(dayIndex, slotIndex){ return `${dayIndex}-${slotIndex}`; }

  function currentWeekKey(){ return weekKeyFor(today); }

  function ensureWeekPlan(wk){
    if(!state.plan[wk]) state.plan[wk] = {};
  }

  function renderPlanner(){
    const wk = currentWeekKey();
    ensureWeekPlan(wk);
    const el = $("planner");
    el.innerHTML = "";

    // Header row
    el.appendChild(div("pl-h",""));
    for(let d=0; d<7; d++) el.appendChild(div("pl-h", days[d]));

    for(let s=0; s<slots.length; s++){
      el.appendChild(div("pl-time", slots[s]));
      for(let d=0; d<7; d++){
        const id = slotId(d,s);
        const cell = document.createElement("div");
        cell.className = "pl-slot";
        cell.dataset.slot = id;

        const blocks = state.plan[wk][id] || [];
        cell.innerHTML = `<div class="muted" style="font-size:11px; font-weight:900">${blocks.length? "":"Click to add"}</div>`;
        blocks.forEach((b, idx)=>{
          const blk = document.createElement("div");
          blk.className = "block";
          blk.innerHTML = `
            <div>
              <div style="font-weight:900">${escapeHtml(b.label)}</div>
              <small>${escapeHtml(b.type)} ‚Ä¢ ${b.hours}h</small>
            </div>
            <button class="x" title="Remove" data-x="${id}" data-i="${idx}">√ó</button>
          `;
          cell.appendChild(blk);
        });

        cell.onclick = (e)=>{
          // if clicking remove button, ignore
          if(e.target && e.target.dataset && e.target.dataset.x) return;
          addBlockToSlot(id);
        };

        el.appendChild(cell);
      }
    }

    el.querySelectorAll("button[data-x]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const id = btn.dataset.x;
        const idx = Number(btn.dataset.i);
        const arr = state.plan[wk][id] || [];
        arr.splice(idx,1);
        state.plan[wk][id] = arr;
        save(); renderPlanner();
      };
    });
  }

  function div(cls, text){
    const d = document.createElement("div");
    d.className = cls;
    d.textContent = text;
    return d;
  }

  function addBlockToSlot(id){
    const label = prompt("Block label:", "Career: apply + message");
    if(label===null) return;
    const type = prompt("Type: work/career/build/gym/walk/dog/family", "career");
    if(type===null) return;
    const hours = prompt("Hours (e.g. 0.5, 1, 1.5, 2):", "1");
    if(hours===null) return;

    const wk = currentWeekKey();
    ensureWeekPlan(wk);
    if(!state.plan[wk][id]) state.plan[wk][id] = [];
    state.plan[wk][id].push({ label: label.trim(), type: type.trim().toLowerCase(), hours: Number(hours)||1 });
    save(); renderPlanner();
  }

  $("addQuickBlockBtn").onclick = ()=>{
    const label = ($("blkLabel").value||"").trim() || "Block";
    const type = $("blkType").value;
    const hours = Number($("blkDur").value)||1;

    const wk = currentWeekKey();
    ensureWeekPlan(wk);

    // find next empty slot
    for(let s=0;s<slots.length;s++){
      for(let d=0;d<7;d++){
        const id = slotId(d,s);
        const arr = state.plan[wk][id] || [];
        if(arr.length===0){
          state.plan[wk][id] = [{label, type, hours}];
          save(); renderPlanner();
          toast("Added to next empty slot.");
          return;
        }
      }
    }
    toast("No empty slots. Remove something first.");
  };

  $("clearPlanBtn").onclick = ()=>{
    const wk = currentWeekKey();
    if(!confirm("Clear this week's plan?")) return;
    state.plan[wk] = {};
    save(); renderPlanner();
  };

  $("autoPlanBtn").onclick = ()=>{
    // Simple autoplan: dog daily EVE, gym Mon/Wed/Fri PM2, career Tue/Thu AM1, build Wed AM2, family Sat/Sun PM1
    const wk = currentWeekKey();
    state.plan[wk] = {};

    const put = (dayIdx, slotIdx, label, type, hours)=>{
      const id = slotId(dayIdx, slotIdx);
      if(!state.plan[wk][id]) state.plan[wk][id] = [];
      state.plan[wk][id].push({label, type, hours});
    };

    for(let d=0;d<7;d++) put(d,4,"Dog walk", "dog", 0.5);
    put(0,3,"Gym", "gym", 1);
    put(2,3,"Gym", "gym", 1);
    put(4,3,"Gym", "gym", 1);

    put(1,0,"Career: apply + message", "career", 1);
    put(3,0,"Career: pipeline push", "career", 1);

    put(2,1,"Build: case-study project", "build", 1.5);

    put(5,2,"Family block", "family", 2);
    put(6,2,"Family block", "family", 2);

    put(0,0,"Work: deliverable", "work", 2);
    put(2,0,"Work: deliverable", "work", 2);
    put(4,0,"Work: deliverable", "work", 2);

    save(); renderPlanner();
    toast("Auto-plan done.");
  };

  // ---- Jobs
  function renderJobs(){
    const tbody = $("jobsTbody");
    const q = ($("jobFilter").value || "").toLowerCase().trim();
    const rows = state.jobs
      .filter(j=>{
        if(!q) return true;
        return [j.rank, j.daysOffice, j.company, j.careersLink, j.status, j.jobLink, j.dateApplied, j.impact, j.actionOnMe]
          .some(x => String(x||"").toLowerCase().includes(q));
      })
      .sort((a,b)=> String(a.rank||"").localeCompare(String(b.rank||"")));

    tbody.innerHTML = "";
    rows.forEach(j=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap"><input value="${esc(j.rank)}" data-k="rank" data-id="${j.id}" style="width:70px"/></td>
        <td class="nowrap"><input value="${esc(j.daysOffice)}" data-k="daysOffice" data-id="${j.id}" style="width:70px"/></td>
        <td><input value="${esc(j.company)}" data-k="company" data-id="${j.id}" style="min-width:160px"/></td>
        <td>
          <input value="${esc(j.careersLink)}" data-k="careersLink" data-id="${j.id}" style="min-width:220px"/>
          ${j.careersLink ? `<div><a href="${escAttr(j.careersLink)}" target="_blank" rel="noopener">Open</a></div>`:""}
        </td>
        <td><input value="${esc(j.status)}" data-k="status" data-id="${j.id}" style="min-width:120px"/></td>
        <td>
          <input value="${esc(j.jobLink)}" data-k="jobLink" data-id="${j.id}" style="min-width:220px"/>
          ${j.jobLink ? `<div><a href="${escAttr(j.jobLink)}" target="_blank" rel="noopener">Open</a></div>`:""}
        </td>
        <td class="nowrap"><input value="${esc(j.dateApplied)}" data-k="dateApplied" data-id="${j.id}" style="width:120px"/></td>
        <td><input value="${esc(j.impact)}" data-k="impact" data-id="${j.id}" style="min-width:180px"/></td>
        <td><input value="${esc(j.actionOnMe)}" data-k="actionOnMe" data-id="${j.id}" style="min-width:180px"/></td>
        <td class="right nowrap"><button class="btn bad" data-del="${j.id}">Del</button></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("input[data-k]").forEach(inp=>{
      inp.oninput = ()=>{
        const id = inp.dataset.id;
        const k = inp.dataset.k;
        const row = state.jobs.find(x=>x.id===id);
        if(!row) return;
        row[k] = inp.value;
        save(); renderJobKPIs();
      };
    });

    tbody.querySelectorAll("button[data-del]").forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.del;
        const i = state.jobs.findIndex(x=>x.id===id);
        if(i>=0){ state.jobs.splice(i,1); save(); renderJobs(); renderJobKPIs(); }
      };
    });
  }

  function renderJobKPIs(){
    const top = state.jobs.filter(j=>String(j.rank||"").startsWith("1")).length;
    const active = state.jobs.filter(j=>/applied|interview|screen|progress/i.test(String(j.status||""))).length;
    const cold = state.jobs.filter(j=>/no jobs|not applied/i.test(String(j.status||""))).length;
    $("kpiTop").textContent = String(top);
    $("kpiActive").textContent = String(active);
    $("kpiCold").textContent = String(cold);
  }

  $("addJobBtn").onclick = ()=>{
    state.jobs.unshift({ id: uid(), rank:"1", daysOffice:"", company:"", careersLink:"", status:"Not Applied", jobLink:"", dateApplied:"", impact:"", actionOnMe:"" });
    save(); renderJobs(); renderJobKPIs();
  };

  $("jobFilter").oninput = ()=> renderJobs();

  $("parseJobsBtn").onclick = ()=>{
    const txt = $("jobsPaste").value || "";
    const lines = txt.split(/\n+/).map(l=>l.trim()).filter(Boolean);
    if(lines.length===0){ toast("Paste something first."); return; }

    let added = 0;
    for(const line of lines){
      if(/^Ranking\b/i.test(line) || /Ranking\s+1-5/i.test(line)) continue;
      const parts = line.split("\t").map(s=>s.trim());
      if(parts.length < 4) continue;
      const [rank, daysOffice, company, careersLink, status, jobLink, dateApplied, impact, actionOnMe] = parts;
      if(!company && !careersLink && !jobLink) continue;

      state.jobs.push({
        id: uid(),
        rank: rank || "",
        daysOffice: daysOffice || "",
        company: company || "",
        careersLink: careersLink || "",
        status: status || "",
        jobLink: jobLink || "",
        dateApplied: dateApplied || "",
        impact: impact || "",
        actionOnMe: actionOnMe || ""
      });
      added++;
    }
    save(); renderJobs(); renderJobKPIs();
    toast(`Added ${added} rows.`);
  };
  $("clearPasteBtn").onclick = ()=> $("jobsPaste").value = "";

  // ---- Values / chimp
  function splitLines(s){ return (s||"").split(/\n+/).map(x=>x.trim()).filter(Boolean); }

  function renderValues(){
    $("idHeadline").value = state.values.headline;
    $("cornerstones").value = state.values.cornerstones.join("\n");
    $("nonnegotiables").value = state.values.nonnegotiables.join("\n");

    $("chimpTriggers").value = state.chimp.triggers.join("\n");
    $("chimpSoothing").value = state.chimp.soothing.join("\n");
    $("computerRules").value = state.chimp.rules.join("\n");

    $("idHeadline").oninput = ()=>{ state.values.headline = $("idHeadline").value; save(); renderIdentity(); };
    $("cornerstones").oninput = ()=>{ state.values.cornerstones = splitLines($("cornerstones").value); save(); renderIdentity(); };
    $("nonnegotiables").oninput = ()=>{ state.values.nonnegotiables = splitLines($("nonnegotiables").value); save(); };

    $("chimpTriggers").oninput = ()=>{ state.chimp.triggers = splitLines($("chimpTriggers").value); save(); };
    $("chimpSoothing").oninput = ()=>{ state.chimp.soothing = splitLines($("chimpSoothing").value); save(); };
    $("computerRules").oninput = ()=>{ state.chimp.rules = splitLines($("computerRules").value); save(); };
  }

  // ---- Export/Import/Reset
  $("exportBtn").onclick = ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `mission-control-backup-${todayKey}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  $("importBtn").onclick = ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = ()=>{
      const file = input.files && input.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const incoming = JSON.parse(String(r.result||"{}"));
          const s = structuredClone(defaultState);
          deepMerge(s, incoming);
          state = s;
          save(); render(); toast("Imported.");
        }catch{ toast("Import failed (bad JSON)."); }
      };
      r.readAsText(file);
    };
    input.click();
  };

  $("resetBtn").onclick = ()=>{
    if(!confirm("Reset ALL local data?")) return;
    localStorage.removeItem(KEY);
    state = load();
    save(); render();
    toast("Reset.");
  };

  // ---- Timer
  let timerSec = 60*60;
  let timerRunning = false;
  let timerHandle = null;

  function fmtTimer(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function updateTimerUI(){
    $("timerLeft").textContent = fmtTimer(timerSec);
  }
  function resetTimer(){
    const mins = Number($("timerPreset").value)||60;
    timerSec = mins * 60;
    timerRunning = false;
    if(timerHandle){ clearInterval(timerHandle); timerHandle=null; }
    updateTimerUI();
  }
  function startTimer(){
    if(timerRunning) return;
    timerRunning = true;
    if(timerHandle) clearInterval(timerHandle);
    timerHandle = setInterval(()=>{
      timerSec = Math.max(0, timerSec - 1);
      updateTimerUI();
      if(timerSec===0){
        clearInterval(timerHandle); timerHandle=null; timerRunning=false;
        toast("Timer done. Claim the win.");
      }
    }, 1000);
  }
  function pauseTimer(){
    timerRunning = false;
    if(timerHandle){ clearInterval(timerHandle); timerHandle=null; }
  }
  $("timerPreset").onchange = ()=> resetTimer();
  $("timerStart").onclick = ()=> startTimer();
  $("timerPause").onclick = ()=> pauseTimer();
  $("timerReset").onclick = ()=> resetTimer();

  // ---- Helpers
  function esc(s){ return escapeHtml(s); }
  function escAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

  // ---- Render
  function render(){
    renderHeader();
    renderTabs();
    showView();

    renderIdentity();
    renderLicence();

    renderTargets();
    renderGame();
    renderMissions();
    renderWeeklyHours();
    renderBadges();

    renderPlanner();

    renderJobs();
    renderJobKPIs();

    renderValues();
    resetTimer();
  }

  // Set initial tab buttons
  function initTabs(){
    // attach click for tab switching
    // already in renderTabs
  }

  // Default missions if empty
  ensureDay();
  addDefaultMissionsIfEmpty();
  save();

  render();
})();
  const PRIMARY = "https://mission-control-eight-blue.vercel.app";

$("checkJobsBtn").onclick = async () => {
  const r = await fetch(`${PRIMARY}/api/jobs`);
  alert(await r.text());
};

$("genCvBtn").onclick = async () => {
  alert("CV generator wired. Next step will open prompts.");
};
</script>
</body>
</html>
